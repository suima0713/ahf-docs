{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "AHF v0.6.3 MVP-4+ Schema",
  "description": "T1限定・Star整数評価・Edge管理・AnchorLint v1対応",
  "type": "object",
  "properties": {
    "meta": {
      "type": "object",
      "properties": {
        "version": {"type": "string", "const": "v0.6.3"},
        "as_of": {"type": "string", "format": "date"},
        "ticker": {"type": "string"},
        "generator": {"type": "string"},
        "auditor": {"type": "string"},
        "tiebreak": {"type": "string"}
      },
      "required": ["version", "as_of", "ticker"]
    },
    "core_evaluation": {
      "type": "object",
      "properties": {
        "right_shoulder": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "kpi": {"type": "string"},
              "value": {"type": "number"},
              "unit": {"type": "string"},
              "asof": {"type": "string"},
              "verbatim_≤25w": {"type": "string", "maxLength": 25},
              "anchor": {"type": "string"},
              "anchor_backup": {
                "type": "object",
                "properties": {
                  "pageno": {"type": "integer"},
                  "quote": {"type": "string", "maxLength": 25},
                  "hash": {"type": "string"}
                },
                "required": ["pageno", "quote", "hash"]
              },
              "find_path": {
                "type": "string",
                "enum": ["xbrl", "note", "md&a", "fallback_text", "manual"]
              },
              "dual_anchor_status": {
                "type": "string",
                "enum": ["CONFIRMED", "PENDING_SEC", "SINGLE"]
              }
            },
            "required": ["kpi", "value", "unit", "asof", "verbatim_≤25w", "anchor"]
          }
        },
        "slope_quality": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "kpi": {"type": "string"},
              "value": {"type": "number"},
              "unit": {"type": "string"},
              "asof": {"type": "string"},
              "verbatim_≤25w": {"type": "string", "maxLength": 25},
              "anchor": {"type": "string"},
              "anchor_backup": {
                "type": "object",
                "properties": {
                  "pageno": {"type": "integer"},
                  "quote": {"type": "string", "maxLength": 25},
                  "hash": {"type": "string"}
                },
                "required": ["pageno", "quote", "hash"]
              },
              "find_path": {
                "type": "string",
                "enum": ["xbrl", "note", "md&a", "fallback_text", "manual"]
              },
              "dual_anchor_status": {
                "type": "string",
                "enum": ["CONFIRMED", "PENDING_SEC", "SINGLE"]
              }
            },
            "required": ["kpi", "value", "unit", "asof", "verbatim_≤25w", "anchor"]
          }
        },
        "time_profile": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "kpi": {"type": "string"},
              "value": {"type": "number"},
              "unit": {"type": "string"},
              "asof": {"type": "string"},
              "verbatim_≤25w": {"type": "string", "maxLength": 25},
              "anchor": {"type": "string"},
              "anchor_backup": {
                "type": "object",
                "properties": {
                  "pageno": {"type": "integer"},
                  "quote": {"type": "string", "maxLength": 25},
                  "hash": {"type": "string"}
                },
                "required": ["pageno", "quote", "hash"]
              },
              "find_path": {
                "type": "string",
                "enum": ["xbrl", "note", "md&a", "fallback_text", "manual"]
              },
              "dual_anchor_status": {
                "type": "string",
                "enum": ["CONFIRMED", "PENDING_SEC", "SINGLE"]
              }
            },
            "required": ["kpi", "value", "unit", "asof", "verbatim_≤25w", "anchor"]
          }
        }
      }
    },
    "edge_evaluation": {
      "type": "object",
      "properties": {
        "edge_items": {
          "type": "array",
          "maxItems": 8,
          "items": {
            "type": "object",
            "properties": {
              "kpi": {"type": "string"},
              "value": {"type": "number"},
              "unit": {"type": "string"},
              "asof": {"type": "string"},
              "confidence": {"type": "number", "minimum": 0, "maximum": 100},
              "direction": {"type": "string", "enum": ["bullish", "bearish", "neutral"]},
              "source": {"type": "string"},
              "ttl_days": {"type": "integer", "minimum": 1, "maximum": 365},
              "contradiction": {"type": "boolean"},
              "footnote": {"type": "string", "maxLength": 35},
              "axis": {"type": "string", "enum": ["①右肩", "②勾配", "③時間軸", "④認知ギャップ"]}
            },
            "required": ["kpi", "confidence", "direction", "source", "axis"]
          }
        }
      }
    },
    "star_evaluation": {
      "type": "object",
      "properties": {
        "stars": {"type": "integer", "minimum": 1, "maximum": 5},
        "core_stars": {"type": "integer", "minimum": 1, "maximum": 5},
        "edge_adjustment": {"type": "integer", "minimum": -1, "maximum": 1},
        "description": {"type": "string"}
      },
      "required": ["stars", "core_stars", "edge_adjustment"]
    },
    "direction_probability": {
      "type": "object",
      "properties": {
        "direction_prob_up_pct": {"type": "number", "minimum": 0, "maximum": 100},
        "direction_prob_down_pct": {"type": "number", "minimum": 0, "maximum": 100}
      },
      "required": ["direction_prob_up_pct", "direction_prob_down_pct"],
      "additionalProperties": false
    },
    "confidence_level": {
      "type": "object",
      "properties": {
        "confidence_pct": {"type": "number", "minimum": 50, "maximum": 95},
        "base_confidence": {"type": "number", "minimum": 0, "maximum": 100},
        "edge_adjustment": {"type": "number", "minimum": -5, "maximum": 5},
        "description": {"type": "string"}
      },
      "required": ["confidence_pct", "base_confidence", "edge_adjustment"]
    },
    "gate_colors": {
      "type": "object",
      "properties": {
        "alpha4_gate_color": {"type": "string", "enum": ["green", "amber", "red"]},
        "alpha5_band_color": {"type": "string", "enum": ["green", "amber", "red", "TBD"]}
      }
    },
    "alpha_bridge": {
      "type": "object",
      "properties": {
        "alpha2_loss_controls": {
          "type": "object",
          "properties": {
            "alpha2_status": {"type": "string", "enum": ["PASS", "FAIL"]},
            "controls_count": {"type": "integer", "minimum": 0},
            "description": {"type": "string"}
          }
        },
        "alpha3_stage_evaluation": {
          "type": "object",
          "properties": {
            "alpha3_delta_gm_pp": {"type": "number"},
            "alpha3_ebitda_impact_$k": {"type": "number"},
            "stage1_mix": {"type": "number"},
            "stage2_efficiency": {"type": "number"},
            "description": {"type": "string"}
          }
        },
        "alpha4_rpo_coverage": {
          "type": "object",
          "properties": {
            "alpha4_coverage_months": {"type": "number"},
            "alpha4_gate_pass": {"type": "boolean"},
            "alpha4_gate_color": {"type": "string", "enum": ["green", "amber", "red"]},
            "rpo_12m_$k": {"type": "number"},
            "quarterly_revenue_$k": {"type": "number"},
            "description": {"type": "string"}
          }
        },
        "alpha5_opex_ebitda_triangulation": {
          "type": "object",
          "properties": {
            "alpha5_opex_actual_$k": {"type": "number"},
            "alpha5_opex_calculated_$k": {"type": "number"},
            "alpha5_deviation_$k": {"type": "number"},
            "alpha5_tolerance_$k": {"type": "number"},
            "alpha5_math_pass": {"type": "boolean"},
            "description": {"type": "string"}
          }
        }
      }
    },
    "auto_checks": {
      "type": "object",
      "properties": {
        "alpha4_gate_pass": {"type": "boolean"},
        "alpha5_math_pass": {"type": "boolean"},
        "anchor_lint_pass": {"type": "boolean"},
        "messages": {
          "type": "array",
          "items": {"type": "string"}
        }
      },
      "required": ["alpha4_gate_pass", "alpha5_math_pass", "anchor_lint_pass"]
    },
    "gap_reason": {
      "type": "object",
      "properties": {
        "field": {"type": "string"},
        "status": {"type": "string", "const": "data_gap"},
        "reason": {
          "type": "string",
          "enum": ["NOT_DISCLOSED", "DIFF_PERIOD", "TAG_ABSENT", "PHRASE_NOT_FOUND", "ANCHOR_INVALID"]
        },
        "ttl_days": {"type": "integer", "minimum": 1, "maximum": 365}
      },
      "required": ["field", "status", "reason", "ttl_days"]
    },
    "triage": {
      "type": "object",
      "properties": {
        "as_of": {"type": "string", "format": "date"},
        "CONFIRMED": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "kpi": {"type": "string"},
              "value": {"type": "number"},
              "unit": {"type": "string"},
              "asof": {"type": "string"},
              "tag": {"type": "string", "enum": ["T1-core", "T1-adj"]},
              "url": {"type": "string"},
              "confidence": {"type": "number", "minimum": 0, "maximum": 100}
            },
            "required": ["kpi", "value", "unit", "asof", "tag", "url"]
          }
        },
        "UNCERTAIN": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "kpi": {"type": "string"},
              "status": {"type": "string", "enum": ["blocked_source", "not_found"]},
              "url_index": {"type": "string"},
              "confidence": {"type": "number", "minimum": 0, "maximum": 100},
              "ttl_days": {"type": "integer", "minimum": 1, "maximum": 365}
            },
            "required": ["kpi", "status", "url_index"]
          }
        }
      },
      "required": ["as_of", "CONFIRMED", "UNCERTAIN"]
    }
  },
  "required": ["meta", "core_evaluation", "star_evaluation", "direction_probability", "confidence_level", "auto_checks"]
}

