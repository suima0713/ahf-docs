# AHF決定事項実装サマリー v2.0

## 実装完了日時
2025-09-22 05:20 JST

## 決定事項の実装状況

### ✅ 完了項目

#### 1. 設定YAMLファイル群の作成
- **tickers.yaml**: ティッカー設定（CIK、IRドメイン、セグ名、単位等）
- **v_overlay.yaml**: V-Overlay 2.0設定（閾値・重み・ヒステリシス）
- **lexicon.yaml**: 因果辞書・同義語・除外リスト

#### 2. T判定エンジンの実装
- **ファイル**: `ahf_t_judgment_engine.py`
- **機能**: 辞書×正規化による機械ルールで一意判定
- **判定基準**:
  - T=2: QoQとYoYの両方で因果句が逐語で存在し、方向一致
  - T=1: 片側のみ満たす
  - T=0: いずれも無い／方向矛盾／アンカー不成立

#### 3. V-Overlay 2.0の実装
- **ファイル**: `ahf_v_overlay_v2.py`
- **機能**: EV/SalesとRule-of-40の合成評価＋ヒステリシス制御
- **合成スコア**: V_score = 0.7*score_EV + 0.3*score_Ro40
- **区分**: Green < 0.25 < Amber < 0.6 < Red
- **ヒステリシス**: 前回区分からの切替は閾値±余裕帯を超えた時のみ更新

#### 4. α3/α5ボーナス判定の厳格化
- **ファイル**: `ahf_alpha_bonus_strict.py`
- **機能**: 両PASSのみ＋MD&A逐語必須の条件で+1★付与
- **厳格条件**:
  - α3: |GM_drift| ≤ 0.2pp かつ Residual_GP ≤ $8M
  - α5: median(OpEx_grid) − OpEx_actual ≤ −$3M
  - MD&A逐語に一次説明（因果句）1本以上

#### 5. 三段化抽出パイプラインの実装
- **ファイル**: `ahf_extraction_pipeline.py`
- **フロー**: facts.md → 前処理YAML → 正規化JSON
- **処理順序**:
  1. AnchorLint → 2. 因果文抽出 → 3. 数値正規化 → 4. α3/α5算出 → 5. TRI-3＋V-Overlay → 6. マトリクス出力

#### 6. DUOL再評価テストの実行
- **ファイル**: `ahf_duol_rklb_test.py`
- **結果**: 差分ログとJSON結果の生成
- **主要差分**:
  - V-Overlay: Green → Amber (Vスコア: 0.350)
  - αボーナス: +0★ (厳格化により)
  - T判定: T=1 (方向一貫性: False)

## 実装の効果

### 機械化・一意化の成果
1. **T判定**: 辞書×正規化による機械ルールで一意判定（手動排除）
2. **V-Overlay**: EV/SalesとRule-of-40の合成＋ヒステリシス（閾値ブレ抑制）
3. **αボーナス**: "両PASSのみ＋MD&A逐語"に限定（ノイズ抑制、業界例外なし）
4. **抽出**: facts.md→前処理YAML→正規化JSONの三段化（自動化）
5. **設定**: すべてYAML化（追加ティッカーはYAML1枚で増設）

### 運用コスト削減
- 設定変更はYAMLファイルのみ編集
- 新規ティッカー追加は設定ファイル1枚で完了
- 機械判定により人的判断の揺れを排除
- ヒステリシス制御により頻繁な区分変更を防止

### 精度・再現性向上
- 辞書ベースの因果判定で一意性確保
- 合成評価により単一指標依存を回避
- 厳格な条件設定によりノイズを排除
- 三段化パイプラインにより処理の透明性確保

## ファイル構成

```
ahf/
├── config/
│   ├── tickers.yaml          # ティッカー設定
│   ├── v_overlay.yaml        # V-Overlay設定
│   └── lexicon.yaml          # 因果辞書
└── _scripts/
    ├── ahf_t_judgment_engine.py      # T判定エンジン
    ├── ahf_v_overlay_v2.py           # V-Overlay 2.0
    ├── ahf_alpha_bonus_strict.py     # αボーナス厳格判定
    ├── ahf_extraction_pipeline.py    # 三段化抽出パイプライン
    ├── ahf_duol_rklb_test.py         # 再評価テスト
    └── duol_revaluation_log_*.txt    # 差分ログ
```

## 次のステップ

1. **RKLBテストの実行**: DUOLと同様の再評価テスト
2. **ゴールデン20銘柄での検証**: セクター別での再現テスト
3. **プロパティテスト**: ヒステリシスの動作検証
4. **本番環境への展開**: 既存ワークフローへの統合

## 決定事項の完全実装

✅ **T判定＝辞書×正規化の機械ルールで一意判定（手動排除）**  
✅ **V-Overlay 2.0＝EV/SalesとRule-of-40の合成＋ヒステリシス（閾値ブレ抑制）**  
✅ **α3/α5ボーナス＝"両PASSのみ＋MD&A逐語"に限定（ノイズ抑制、業界例外なし）**  
✅ **抽出はfacts.md→前処理YAML→正規化JSONの三段化（自動化）**  
✅ **設定はすべてYAML化（追加ティッカーはYAML1枚で増設）**  

**この3点で精度・再現性・保守性が一気に上がる実装が完了しました。**
